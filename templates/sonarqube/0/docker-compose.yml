version: '2'
services:
  sonarqube:
    image: sonarqube:6.5-alpine
    environment:
      SONARQUBE_JDBC_URL: jdbc:postgresql://database:${postgres_port}/${postgres_db}
      SONARQUBE_JDBC_USERNAME: ${postgres_user}
      SONARQUBE_JDBC_PASSWORD: ${postgres_password}
      SONARQUBE_WEB_JVM_OPTS: ${jvm_opts}
    volumes_from:
      - sonarqube-storage
    links:
      - database:database
    labels:
      io.rancher.container.hostname_override: container_name
      io.rancher.sidekicks: sonarqube-storage
  database:
    image: postgres:9.6.3-alpine
    environment:
      POSTGRES_DB:  ${postgres_db}
      POSTGRES_USER:  ${postgres_user}
      POSTGRES_PASSWORD:  ${postgres_password}
    volumes_from:
      - database-storage
    labels:
      io.rancher.container.hostname_override: container_name
      io.rancher.sidekicks: database-storage
  database-storage:
    image: rawmind/alpine-volume:0.0.2-2
    network_mode: none
    environment:
      - SERVICE_UID=0
      - SERVICE_GID=0
      - SERVICE_VOLUME=/var/lib/postgresql
    volumes:
      - database-data:/var/lib/postgresql
    labels:
      io.rancher.container.hostname_override: container_name
      io.rancher.container.start_once: true
  sonarqube-storage:
    image: rawmind/alpine-volume:0.0.2-2
    network_mode: none
    environment:
      - SERVICE_UID=0
      - SERVICE_GID=0
      - SERVICE_VOLUME=/opt/sonarqube/extensions/plugins
    volumes:
      - sonarqube-plugin:/opt/sonarqube/extensions/plugins
    labels:
      io.rancher.container.hostname_override: container_name
      io.rancher.container.start_once: true
volumes:
  sonarqube-plugin:
    driver: ${VOLUME_DRIVER}
    external: true
  database-data:
    driver: ${VOLUME_DRIVER}
    external: true